name: Comment when fixed in stable

on:
  issues:
    types: [labeled]

permissions:
  issues: write
  contents: read

jobs:
  comment-when-fixed-in-stable:
    if: github.event.label.name == 'status/fixedInStable'
    runs-on: ubuntu-latest

    steps:
      - name: Add comment with stable download link
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const issueNumber = context.payload.issue.number;

            const [issueOwner, issueRepo] = process.env.GITHUB_REPOSITORY.split("/");
            
            const releaseOwner = "MeterReadings";
            const releaseRepo  = "meter-readings-apk";
            
            const { data: releases } = await github.rest.repos.listReleases({
              owner: releaseOwner,
              repo: releaseRepo,
              per_page: 50
            });
            
            const latestStable = releases.find(r =>
              !r.draft &&
              !r.prerelease &&
              !/beta/i.test((r.tag_name || "") + " " + (r.name || ""))
            );

            const stableVersion = latestStable?.tag_name || latestStable?.name || "unknown";

            const lines = [
              "âœ… This issue has been marked as **fixed in the latest stable version** of the app.",
              "",
              `**Version ${stableVersion}**`,
              "",
              "You can download the current stable APK here:",
              "ðŸ‘‰ https://github.com/MeterReadings/meter-readings-apk/releases",
              "",
              "Please install that stable build, try to reproduce the problem again,",
              "and then leave a comment in this issue to confirm whether the bug is really fixed.",
              "",
              "**Important:** Before installing the apk, create a backup of your database:",
              "App â†’ Settings â†’ Database settings â†’ Export database (save it to local storage, not to a cloud folder)."
            ];

            await github.rest.issues.createComment({
              owner: issueOwner,
              repo: issueRepo,
              issue_number: issueNumber,
              body: lines.join("\n")
            });
